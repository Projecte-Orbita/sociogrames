---
title: "Sociograma Cicle Inicial"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F)
require(ggplot2)
require(reshape2)
require(igraph)
#library(kableExtra)
set.seed(1111)
```

Introducció
===

El sociograma és una tècnica d'anàlisi de dades que permet visualitzar de forma gràfica diferents variables implicades en les relacions entre subjectes. A nivell educatiu, suposa una eina per comprendre el sistema d'interaccions socials d'un grup-classe, aportant informació sobre la intensitat i la qualitat de les relacions entre els alumnes. Conèixer la posició sociomètrica de cada estudiant, així com comprendre els subgrups dins l'aula ens permet elaborar estratègies per facilitar la convivència escolar i influir en el benestar dels alumnes atenent les seves necessitats.

Si trobeu errors o conceptes o gràfics que no s'entenen si us plau feu-nos-ho saber a info\@projecteorbita.cat. 

```{r}
# importem
soc = read.csv('Preguntes sociograma - sociograma_CI.csv', fileEncoding = "UTF-8")
colnames(soc)[1] = "noms"
```

```{r, include = F}
# petita funció que omple els buits de l'excel, en cas de qui n'hi hagi (és equivalent al forward fill de python, que en R no existeix) - si s'acaba necessitant s'hauria de posar en un document a part

ffill <- function(vector, type){
  a = 0

  if (is.na(type)){
    for (i in 1:length(vector)){
      if (!is.na(vector[i])){
        a = vector[i]
        }
      else vector[i]=a
    }
  }
  else {
    for (i in 1:length(vector)){
      if (vector[i]!=type){
        a = vector[i]
        }
      else vector[i]=a
    }
  }
  return (vector)
}

#soc$número =ffill(soc$número, NA)
#soc$nom = ffill(soc$nom, "")
```

```{r}
# Calculem el recompte de quantes vegades cada nen ha estat anomenat en cada categoria:
num_anomenats = 3 # quants nens es poden anomenar en totes les categories
mat = matrix(data = 0, 
             nrow = nrow(soc)/num_anomenats, 
             ncol = ncol(soc)-2)

for (j in 1:ncol(mat)){
  for (i in 1:nrow(mat)){
    mat[i,j] = sum(soc[,j+2]==i)
  }
}
colnames(mat) = colnames(soc[,3:ncol(soc)])
```

```{r}
# Estandaritzem tots els resultats:
mat_est = scale(mat)
```

```{r}
# popularitat i preferències generals i de feina - preparació
# Calculem l'impacte total i la preferència total i les seves estandaritzacions:
imp = mat[,1] + mat[,2] + mat[,3] + mat[,4]
pref_feina = mat[,1] - mat[,2]
pref_jugar = mat[,3] - mat[,4]
pref = pref_feina + pref_jugar

imp_pref = cbind(imp, pref, pref_feina, pref_jugar)
imp_pref_est = scale(imp_pref)
```

```{r}
# Disrupció (antiga agressivitat)

dis_relacional = mat[,15] + mat[,17] 
dis_directe = mat[,7] + mat[,10] + mat[,12] 

dis_total = dis_relacional + dis_directe

disrupcio = cbind(dis_relacional, dis_directe, dis_total)
disrupcio_est = scale(disrupcio)
```

```{r}
# Prosocialitat:
prosocialitat = mat[,6] + mat[,9] + mat[,14]
prosocialitat_est = scale(prosocialitat)
```

```{r}
# Victimisme
victima_directe = mat[,8] + mat[,11] + mat[,13]
victima_relacional = mat[,7] + mat[,18]
victima_total = victima_directe + victima_relacional
victima_est = scale(victima_total)
```

```{r}
# sociològic
amics_percebut = mat[,19] - mat[,20]

amics_est = scale(amics_percebut)

```

```{r}
# emocional
content = mat[,21] - mat[,22]
content_est = scale(content)
```

```{r}
# Puntuacions finals:
popularitat_feina = ifelse(mat_est[,1] > 0, 1, 0) + 
  ifelse(imp_pref_est[,3] > 1, 1, 0) + 
  ifelse(mat_est[,2] < 0, 1, 0)
popularitat_jugar = ifelse(mat_est[,1] > 0, 1, 0) + 
  ifelse(imp_pref_est[,3] > 1, 1, 0) + 
  ifelse(mat_est[,2] < 0, 1, 0)

popularitat = ifelse((mat_est[,1] + mat_est[,3])/2 > 0, 1, 0) + 
  ifelse(imp_pref_est[,2] > 1, 1, 0) + 
  ifelse((mat_est[,2] + mat_est[,4])/2 < 0, 1, 0)

rebuig_feina = ifelse(mat_est[,1] > 0, 1, 0) + 
  ifelse(imp_pref_est[,3] < -1, 1, 0) + 
  ifelse(mat_est[,2] > 0, 1, 0)
rebuig_feina = ifelse(mat_est[,3] > 0, 1, 0) + 
  ifelse(imp_pref_est[,4] < -1, 1, 0) + 
  ifelse(mat_est[,4] > 0, 1, 0)

rebuig_total = ifelse((mat_est[,1] + mat_est[,3])/2  < 0, 1, 0) + 
  ifelse(imp_pref_est[,2] < -1, 1, 0) + 
  ifelse((mat_est[,2] + mat_est[,4])/2 > 0, 1, 0)

ignorament = ifelse((mat_est[,1] + mat_est[,3])/2 < 0, 1, 0) + 
  ifelse(imp_pref_est[,1] < -1, 1, 0) + 
  ifelse((mat_est[,2] + mat_est[,4])/2 < 0, 1, 0)

controvèrsia = ifelse((mat_est[,1] + mat_est[,3])/2  > 0, 1, 0) + 
  ifelse(imp_pref_est[,1] > 1, 1, 0) + 
  ifelse((mat_est[,2] + mat_est[,4])/2 > 0, 1, 0)

normalitat = ifelse(imp_pref_est[,2] < 0.5, 1, 0) + 
  ifelse(imp_pref_est[,2] > -0.5, 1, 0)
```

```{r}
# Quadres de resultats:

noms = as.character(soc$nom[seq(1, nrow(soc), num_anomenats)])
Disrupcio = cbind(dis_total, mat[,12], mat[,7] + mat[,10], dis_relacional)
colnames(Disrupcio) = c("Disrupció total", 
                           "Disrupció física",
                           "Disrupció verbal",
                           "Disrupció relacional")

Disrupcio_sino = ifelse(scale(Disrupcio)>1, 1, 0)
Disrupcio = as.data.frame(Disrupcio)
rownames(Disrupcio) = noms
Disrupcio_sino = as.data.frame(Disrupcio_sino)
rownames(Disrupcio_sino) = noms

Prosocialitat = prosocialitat/2
Pro_sino = prosocialitat_est > 1
Pro_sino = ifelse(Pro_sino, 1, 0)
Prosocialitat = as.data.frame(Prosocialitat)
Pro_sino = as.data.frame(Pro_sino)
rownames(Prosocialitat) = noms
rownames(Pro_sino) = noms
colnames(Prosocialitat) = c("Prosocialitat")

Victimització = cbind(victima_total, mat[,13], mat[,8] + mat[,11], victima_relacional)
colnames(Victimització) = c("Total victimització", 
                            "Victimització física", 
                            "Victimització verbal",
                            "Victimització relacional")

Vict_sino = ifelse(scale(Victimització)>1, 1, 0)
rownames(Victimització) = noms
rownames(Vict_sino) = noms
Victimització = as.data.frame(Victimització)

popular_sino = ifelse(amics_est > 1, 1 , ifelse(amics_est < -1, -1, 0))

content_sino = ifelse(content_est > 1, 1, ifelse(content_est< -1, -1, 0))
Content = as.data.frame(content)
Content_sino = as.data.frame(content_sino)
rownames(Content) = noms
rownames(Content_sino) = noms
colnames(Content) = c("Content")

Estatus = cbind(popularitat==3, rebuig_total == 3, ignorament == 3,
                controvèrsia == 3, mat[,1] + mat[,3], mat[,2] + mat[,4], content_sino == 1, content_sino == -1)
rownames(Estatus) = noms
Estatus = as.data.frame(Estatus)
colnames(Estatus) = c("Popular", "Rebutjat", "Ignorat",
                      "Controvertit", "Tries positives", 
                      "Tries negatives", "Content", "Trist")

Estatus_imp = cbind(popularitat==3, rebuig_total == 3, ignorament == 3,
                controvèrsia == 3, popular_sino == 1, popular_sino == -1, content_sino == 1, content_sino == -1)
rownames(Estatus_imp) = noms
Estatus_imp = as.data.frame(Estatus_imp)
colnames(Estatus_imp) = c("Popular", "Rebutjat", "Ignorat",
                      "Controvertit", "Popular percebut", 
                      "Impopular percebut", "Content", "Trist")

```

Presentem cada una de les àrees estudiades per separat, presentant primer un gràfic global i després un desglossament de cada puntuació i en forma de taula.

# Disrupció: 


Els resultats d'aquesta àrea s'obtenen a partir de les respostes dels alumnes a les següents preguntes:

*Qui molesta als altres?*

*Qui insulta als altres?*

*Qui pega als altres?*

*Qui diu coses dolentes dels altres?*

*Qui no deixa participar?*

Per tant aquí estem mesurant el grau de disrupció que preveiem que cada alumne causa a l'aula, principalment causat per l'agressivitat, tan física com relacional. 

```{r}
Disrupcio$noms = as.factor(rownames(Disrupcio))
Disrupcio_sino$noms = rownames(Disrupcio_sino)

agr.m <- melt(Disrupcio[,2:5], id.vars = "noms")
agr_sino.m = melt(Disrupcio_sino[,2:5], id.vars = "noms")
agr.m$color = rep(Disrupcio_sino[,1],3)
agr.m$color[agr.m$color==0] = "plain"
agr.m$color[agr.m$color==1] = "bold"
agr.m$color = as.factor(agr.m$color)
agr.m$noms = factor(agr.m$noms, levels = unique(as.character(agr.m$noms)))
ggplot(agr.m, aes(x = as.factor(noms), y = value, fill=variable)) +
  geom_bar(stat='identity') + 
  theme_bw() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1,
                              face = as.character(agr.m$color))) +
  labs(title = "Disrupció") + 
  ylab("") + 
  xlab("Alumnes")
```

```{r}
Disrupcio$noms = NULL
knitr::kable(Disrupcio, booktabs = TRUE)

```

# Victimització: 

Els resultats d'aquesta àrea s'obtenen a partir de les respostes dels alumnes a les següents preguntes:

*A qui molesten?*

*A qui insulten?*

*A qui peguen?*

*De qui diuen coses dolentes?*

*A qui no deixen participar?*

Aquest apartat és complementari a l'anterior, i analitzem les víctimes que la disrupció i l'agressivitat. 

```{r}
Victimització$noms = rownames(Victimització)
vict.m <- melt(Victimització[,2:5], id.vars = "noms")
vict.m$color = rep(Vict_sino[,1], 3)
vict.m$color[vict.m$color==0] = "plain"
vict.m$color[vict.m$color==1] = "bold"
vict.m$color = as.factor(vict.m$color)
vict.m$noms = factor(vict.m$noms, levels = unique(as.character(vict.m$noms)))
ggplot(vict.m, aes(x = noms, y = value, fill=variable)) +
  geom_bar(stat='identity') + 
  theme_bw() + 
  theme(axis.text.x = element_text(angle = 45, 
                                   hjust = 1,
                              face = vict.m$color)) +
  labs(title = "Victimització") + 
  ylab("") + 
  xlab("Alumnes")
```

```{r}
Victimització$noms = NULL
knitr::kable(Victimització, booktabs = TRUE)
```

# Prosocialitat: 

Els resultats d'aquesta àrea s'obtenen a partir de les respostes dels alumnes a les següents preguntes:

*Qui ajuda als altres?*

*Qui defensa als altres*

*Qui diu coses bones dels altres?*

En aquest apartat mesurem el que anomenem la prosocialitat, que seria el contrari a la disrupció. És a dir, mesurem en quin gran un alumne ajuda als seus companys i crea un bon clima social i escolar.  

```{r}
Prosocialitat$noms = rownames(Prosocialitat)

ggplot(Prosocialitat, aes(x = noms, y = Prosocialitat)) +
  geom_bar(stat='identity', fill = "blue") + 
  theme_bw() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(title = "Prosocialitat") + 
  ylab("") + 
  xlab("Alumnes")

```

```{r}
Prosocialitat$noms = NULL
knitr::kable(Prosocialitat, booktabs = TRUE)
```

# Estatus sociomètric: 

En el següent gràfic mostrem el resultat de la pregunta *"Tria els teus tres millors amics o amigues"* per tal de mostrar quin estatus sociomètric directe (i. e., respòs per ells mateixos) tenen els nens. 


```{r}
Estatus$noms = rownames(Estatus)
Estatus$`Tries negatives` = -  Estatus$`Tries negatives`
estatus.m <- melt(Estatus[,c(5:6,9)], id.vars = "noms")
ggplot(estatus.m, aes(x = noms, y = value, fill=variable)) +
  geom_bar(stat='identity') + 
  theme_bw() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(title = "Estatus sociomètric") + 
  ylab("") + 
  xlab("Alumnes")
```

### Descriptiu:

En la següent taula presentem l'estatus sociomètric global en forma de taula. Les diferents columnes mostres els components sociomètrics que s'estudien en les següents preguntes:

*Qui voldries al teu grup per fer una feina?*	

*Qui NO voldries al teu grup per fer una feina?*

*Qui voldries al teu grup per jugar al pati?*	

*Qui NO voldries al teu grup per jugar al pati?*

*Qui té molts amics?*

*Qui té pocs amics?*

*Qui acostuma a estar content?*

*Qui acostuma a estar trist?*


```{r}
Estatus_imp$noms = NULL
Estatus_imp = sapply(Estatus_imp,function(x) ifelse(x, 1, 0)) 
knitr::kable(Estatus_imp, booktabs = TRUE)
```

# Xarxa


En aquest apartat dibuixem la xarxa de relacions entre els nens i les nenes de la classe partint de la informació de la pregunta "Tria els teus tres millors amics o amigues".

El gràfic consta dels següents elements: 

Cada vèrtex (rodona) és un alumne i cada fletxa és una relació que indica si l'alumne del qual prové la fletxa indica que l'alumne cap al qual va és amic o amiga seva. Recordem que cada alumne en pot seleccionar fins a 3. La mida del vèrtex mostra el número de tries que ha rebut aquell alumne. 

A més, mostrem tres magnituds més: el color dels vèrtex indica el grau de disrupció total per aquell alumne, que ja hem vist en el primer apartat de l'informe. Per altra banda, el color del nom indica si els altres aumnes perceben aquell nen o nena com a especialment content o trist (provinent de les preguntes "Normalment està content" i "Normalment està trist"). Per acabar, en els casos en que dos alumnes indiquen que són amics de forma recíproca, la fletxa es blava.

```{r}
#creo la xarxa
xarxa = soc[,c(1,2,7)]
noms = as.character(xarxa$nom[seq(1,nrow(xarxa),3)])
gg <- graph.data.frame(xarxa[,c(2,3)], directed=T)
gg <- simplify(gg, remove.multiple = F, remove.loops = T) 
deg <- degree(gg, mode="all")

adj = as_adjacency_matrix(gg, sparse = TRUE)

# això és per pintar les relacions bidireccionals de blau (no és molt necessari)
reci = rep(0, nrow(xarxa))
xarxa$relacions = reci

for (i in 1:length(noms)){
  for (j in 1:length(noms)){
    if (adj[i,j] == 1 & adj[j,i] == 1){
      xarxa$relacions[which(xarxa$num==i & xarxa$Amics==j)] = 1
    }
  }
}

V(gg)$label <- as.character(noms)
V(gg)$label.cex = 1
V(gg)$label.font = 2
V(gg)$size <- deg*3
```

```{r}
# faig una paleta manual perquè l'igraph es lia amb la normal:

agressivitat = as.data.frame(Disrupcio[,1])
agressivitat$noms = noms
colnames(agressivitat) = c("disrupcio", "noms")

agressivitat$corregida = agressivitat$disrupcio - min(agressivitat$disrupcio) + 1
paleta <- colorRampPalette(c("chartreuse3", 
                                 "khaki1", 
                                 "firebrick"))(n = max(agressivitat$corregida))
paleta = paste0(paleta, "90")   ## afegeixo transparència

colors = rep("", length(noms))

for (i in 1:length(noms)){
  colors[i] = paleta[agressivitat$corregida[i]]
}
label.color = ifelse(content_est > 1, "chartreuse3", 
                     ifelse(content_est< -1, "firebrick", "black"))
```

```{r fig1, fig.width=12, fig.height=12}
xarxa$relacions = as.factor(xarxa$relacions)
plot(gg,
     layout=layout_with_lgl, # altres opcions són: layout_with_gem layout_with_fr, layout_with_mds, layout_with_lgl
     frame = T,
     vertex.label.color = label.color,
     vertex.color = as.character(colors),
     width = 1.5,
     vertex.frame.color = ifelse(xarxa$relacions==1, 'orange', 'red'),
     vertex.alpha = 0.5,
     edge.color = ifelse(xarxa$relacions==0, "darkblue", "black"), 
     edge.curved = .2,
     edge.arrow.size = 0.55, 
     label.cex = 0.5, 
     main = "Xarxa de relacions a l'aula",
     sub = "Classe X de l'escola Y")

legend(x=0.7, y=-0.9, c("Poc disruptiu","Disrupcio mitjana", "Molt disruptiu"),
       pch=21, col="#777777", pt.bg=c("chartreuse3", "khaki1", "firebrick"),
       pt.cex=3, cex=1.5, bty="n", ncol=1)
legend(x=-1.2, y=-0.9, c("Poc popular","Normal", "Molt popular"),
       pch=21, col="#777777", pt.bg="gray",
       pt.cex=c(4,5,6), cex=1.5, bty="n", ncol=1)
```

Nota: el color del nom del nen o la nena indica si és percebut com a content pels seus companys. Verd és que sí, vermell és que no, negre és que no hi ha prou respostes sobre ell o ella perquè sigui rellevant. 